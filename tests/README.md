# 测试概览

本项目包含了针对Markdown编辑器功能的全面测试套件，遵循四个维度的测试策略。

## 测试架构

### 1. API测试 (`api.test.ts`)
测试Hono API路由和端点的功能。

#### 认证API测试（已有）
- 登录功能测试
- 注册功能测试
- 输入验证测试
- 错误处理测试

#### 文档API测试（新增）
- **创建文档**
  - 成功创建文档
  - 验证必填字段（标题、内容）
  - 处理数据库错误
- **获取文档**
  - 根据ID获取文档
  - 处理不存在的文档（404错误）
- **更新文档**
  - 成功更新文档内容和标题
  - 处理不存在的文档
- **获取用户文档列表**
  - 获取用户的所有文档
  - 处理空文档列表

### 2. 组件测试 (`components.test.tsx`)
使用Testing Library测试React组件的用户交互和渲染。

#### 认证组件测试（已有）
- AuthProvider状态管理
- LoginForm用户交互

#### Markdown编辑器组件测试（新增）
- **MarkdownEditor组件**
  - Monaco Editor渲染
  - 内容变化处理
  - 光标位置变化
  - ref方法暴露（insertText, formatText, focus等）
- **PreviewPane组件**
  - Markdown内容渲染
  - 滚动事件处理
  - 自定义选项支持
- **EditorToolbar组件**
  - 工具栏按钮渲染
  - 保存功能调用
  - 格式化操作（粗体、斜体等）
  - 视图模式切换
  - 加载状态显示
- **SplitView组件**
  - 分屏视图渲染（编辑器+预览）
  - 单一视图模式（仅编辑/仅预览）
  - 内容变化处理
- **编辑器集成测试**
  - 完整的编辑器工作流程测试

### 3. 数据库测试 (`database.test.ts`)
测试Prisma数据库操作和数据完整性。

#### 用户数据库操作（已有）
- 用户查询、创建、更新、删除
- 用户存在性检查

#### 文档数据库操作（新增）
- **文档查询**
  - 根据ID获取文档（包含作者信息）
  - 获取用户的所有文档
  - 处理不存在的文档
- **文档修改**
  - 创建新文档
  - 更新文档内容
  - 删除文档
  - 处理外键约束错误
- **关系测试**
  - 用户与文档的外键关系
  - 级联删除行为测试
- **事务处理**
  - 事务中的文档创建
  - 事务回滚测试

### 4. 验证测试 (`validation.test.ts`)
测试Zod模式验证、Markdown解析和安全性。

#### 模式验证测试（已有）
- 用户创建、登录、更新模式
- 响应模式验证
- API错误模式

#### Markdown验证测试（新增）
- **Markdown解析**
  - 基础Markdown语法解析
  - 空内容处理
  - 特殊字符和中文支持
  - HTML清理和XSS防护
- **数学公式验证**
  - LaTeX公式处理（行内和块级）
  - 公式功能开关控制
- **Mermaid图表验证**
  - 图表代码块处理
  - 图表功能开关控制
- **内容安全验证**
  - 危险脚本内容过滤
  - 安全Markdown元素保留
  - 任务列表正确处理
- **输入长度验证**
  - 超长内容处理
  - 多行内容处理
- **错误处理**
  - 解析错误的优雅处理
  - 无效选项处理

#### 文档统计验证（新增）
- **统计计算**
  - 字数统计
  - 字符数统计
  - 阅读时间估算
  - 段落数统计
- **多语言支持**
  - 中文内容统计
  - 混合语言内容处理
- **边缘情况**
  - 空内容处理
  - 仅空白字符内容

#### 内容安全验证（新增）
- **XSS防护**
  - Script标签过滤
  - 事件处理器过滤
  - JavaScript URL过滤
  - 安全属性保留
- **内容类型验证**
  - 有效Markdown类型支持
  - 二进制内容处理

## 测试运行

### 运行所有测试
```bash
npm run test:all
```

### 按类型运行测试
```bash
npm run test:api          # API测试
npm run test:components   # 组件测试
npm run test:database     # 数据库测试
npm run test:validation   # 验证测试
npm run test:editor       # 编辑器相关测试
```

### 开发模式
```bash
npm run test:watch        # 监视模式
npm run test:ui           # UI界面
npm run test:coverage     # 覆盖率报告
```

## 测试覆盖范围

### 功能覆盖
- ✅ Markdown编辑器完整功能
- ✅ 实时预览
- ✅ 工具栏操作
- ✅ 视图模式切换
- ✅ 滚动同步
- ✅ 文档保存和管理
- ✅ 数学公式渲染
- ✅ Mermaid图表
- ✅ 任务列表
- ✅ XSS安全防护

### 技术覆盖
- ✅ React组件渲染和交互
- ✅ Monaco Editor集成
- ✅ Hono API路由
- ✅ Prisma数据库操作
- ✅ Zod数据验证
- ✅ TypeScript类型安全
- ✅ 错误处理和边缘情况

### 用户场景覆盖
- ✅ 创建和编辑文档
- ✅ 格式化文本（粗体、斜体、代码等）
- ✅ 插入链接、图片、表格
- ✅ 实时预览和同步滚动
- ✅ 保存和加载文档
- ✅ 视图模式切换
- ✅ 错误情况处理

## Mock策略

### 外部依赖Mock
- **Monaco Editor**: 使用简化的textarea模拟编辑器行为
- **DOMPurify**: 简单的HTML清理模拟
- **marked**: Markdown解析器模拟
- **KaTeX/Mermaid**: 动态导入模拟

### 数据库Mock
- **Prisma客户端**: 完整的数据库操作模拟
- **事务处理**: 事务回调模拟
- **约束错误**: 数据库约束错误模拟

### API Mock
- **HTTP请求**: 使用Hono测试实例
- **认证**: JWT token模拟
- **文件操作**: 文档CRUD操作模拟

## 测试最佳实践

1. **隔离性**: 每个测试独立运行，使用beforeEach清理状态
2. **可读性**: 使用描述性的测试名称和分组
3. **完整性**: 测试正常流程、错误情况和边缘案例
4. **性能**: 使用合适的Mock减少测试时间
5. **维护性**: 测试代码结构清晰，易于维护和扩展

## 未来扩展

### 计划添加的测试
- [ ] E2E测试（Playwright）
- [ ] 性能测试
- [ ] 可访问性测试
- [ ] 移动端响应式测试
- [ ] 实时协作功能测试

### 测试工具升级
- [ ] 集成测试覆盖率报告
- [ ] 可视化测试结果
- [ ] CI/CD集成
- [ ] 自动化测试回归 